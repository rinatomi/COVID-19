<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球新冠疫情数据分析统计系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="/static/css/style.css">

    <style>
        .card {
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>

<body>

<header class="header py-3">
    <div class="container">
        <h1 class="text-center mb-0">全球新冠疫情数据分析统计系统</h1>
    </div>
</header>

<!-- 导航菜单 -->
{% include 'navbar.html' %}

<div class="container-fluid px-4 mt-3">
    <!-- 🟦 国家选择 -->
    <div class="card">
        <h4>请选择国家查看病例增长趋势</h4>
        <select id="trend_selector" onchange="onTrendChange()">
            <option value="GLOBAL">全球</option>
            <option value="CN">中国</option>
        </select>
    </div>

    <!-- 📈 增长趋势图 -->
    <div class="card">
        <h4 id="trend_title">病例增长趋势</h4>
        <canvas id="trendChart" height="100"></canvas>
    </div>

    <!-- 🌡 Rt趋势 -->
    <div class="card">
        <h4>有效传播数 Rt</h4>
        <canvas id="rtChart" height="100"></canvas>
    </div>

    <!-- ⚰ 病死率 -->
    <div class="card">
        <h4>疫情严重程度 - 病死率</h4>
        <canvas id="cfrChart" height="100"></canvas>
    </div>
</div>
<script>
    let trendChart = null;
    let rtChart = null;
    let cfrChart = null;

    function loadGrowthTrend(code) {
        const url = code === 'CN'
                ? '/api/china/growth-trend'
                : '/api/global/growth-trend';

        fetch(url)
                .then(res => res.json())
                .then(data => {
                    const labels = data.dates;
                    const rates = data.rates.map(r => (r * 100).toFixed(2));

                    if (trendChart) trendChart.destroy();
                    trendChart = new Chart(document.getElementById('trendChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `${code === 'CN' ? '中国' : '全球'}增长率 (%)`,
                                data: rates,
                                borderColor: code === 'CN' ? '#2980b9' : '#e67e22',
                                backgroundColor: code === 'CN' ? 'rgba(41,128,185,0.2)' : 'rgba(230,126,34,0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        }
                    });

                    document.getElementById('trend_title').innerText =
                            code === 'CN' ? '中国病例增长趋势' : '全球病例增长趋势';
                });
    }

    function loadRtChart(code = 'GLOBAL') {
        const url = code === 'CN' ? '/api/china/rt' : '/api/global/rt';

        fetch(url)
                .then(res => res.json())
                .then(data => {
                    const labels = data.dates;
                    const rtValues = data.rt_values;

                    if (rtChart) rtChart.destroy();
                    rtChart = new Chart(document.getElementById('rtChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Rt 有效传播数',
                                data: rtValues,
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46,204,113,0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        }
                    });
                });
    }

    function loadCfrChart(code = 'GLOBAL') {
        const url = code === 'CN' ? '/api/china/cfr' : '/api/global/cfr';

        fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (cfrChart) cfrChart.destroy();
                    cfrChart = new Chart(document.getElementById('cfrChart'), {
                        type: 'bar',
                        data: {
                            labels: data.dates,
                            datasets: [{
                                label: '病死率 (%)',
                                data: data.cfr_values,
                                backgroundColor: 'rgba(231, 76, 60, 0.5)'
                            }]
                        }
                    });
                });
    }

    function onTrendChange() {
        const selected = document.getElementById('trend_selector').value;
        loadGrowthTrend(selected);
        loadRtChart(selected);
        loadCfrChart(selected);
    }

    window.onload = () => {
        const defaultCountry = 'GLOBAL';
        loadGrowthTrend(defaultCountry);
        loadRtChart(defaultCountry);
        loadCfrChart(defaultCountry);
    };
</script>

{% include 'footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>
</html>