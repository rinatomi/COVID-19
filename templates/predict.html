<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>病例增长趋势 - 新冠疫情数据分析系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-btn {
            padding: 10px 40px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .nav-btn:hover {
            background-color: #f0f0f0;
        }

        .nav-btn.active {
            background-color: #333;
            color: #fff;
            font-weight: bold;
        }

        .card {
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>

<body>

<h2 style="text-align:center;">新冠疫情数据分析系统</h2>

<!-- 🔍 顶部导航栏 -->
{% include 'navbar.html' %}

<!-- 🟦 国家选择 -->
<div class="card">
    <h4>请选择国家查看病例增长趋势</h4>
    <select id="trend_selector" onchange="onTrendChange()">
        <option value="GLOBAL">全球</option>
        <option value="CN">中国</option>
    </select>
</div>

<!-- 📈 增长趋势图 -->
<div class="card">
    <h4 id="trend_title">病例增长趋势</h4>
    <canvas id="trendChart" height="100"></canvas>
</div>

<!-- 🌡 Rt趋势 -->
<div class="card">
    <h4>有效传播数 Rt</h4>
    <canvas id="rtChart" height="100"></canvas>
</div>

<!-- ⚰ 病死率 -->
<div class="card">
    <h4>疫情严重程度 - 病死率</h4>
    <canvas id="cfrChart" height="100"></canvas>
</div>

<script>
    let trendChart = null;
    let rtChart = null;
    let cfrChart = null;

    function loadGrowthTrend(code) {
        const url = code === 'CN'
                ? '/api/china/growth-trend'
                : '/api/global/growth-trend';

        fetch(url)
                .then(res => res.json())
                .then(data => {
                    const labels = data.dates;
                    const rates = data.rates.map(r => (r * 100).toFixed(2));

                    if (trendChart) trendChart.destroy();
                    trendChart = new Chart(document.getElementById('trendChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `${code === 'CN' ? '中国' : '全球'}增长率 (%)`,
                                data: rates,
                                borderColor: code === 'CN' ? '#2980b9' : '#e67e22',
                                backgroundColor: code === 'CN' ? 'rgba(41,128,185,0.2)' : 'rgba(230,126,34,0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        }
                    });

                    document.getElementById('trend_title').innerText =
                            code === 'CN' ? '中国病例增长趋势' : '全球病例增长趋势';
                });
    }

    function loadRtChart(code = 'GLOBAL') {
        const url = code === 'CN' ? '/api/china/rt' : '/api/global/rt';

        fetch(url)
                .then(res => res.json())
                .then(data => {
                    const labels = data.dates;
                    const rtValues = data.rt_values;

                    if (rtChart) rtChart.destroy();
                    rtChart = new Chart(document.getElementById('rtChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Rt 有效传播数',
                                data: rtValues,
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46,204,113,0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        }
                    });
                });
    }

    function loadCfrChart(code = 'GLOBAL') {
        const url = code === 'CN' ? '/api/china/cfr' : '/api/global/cfr';

        fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (cfrChart) cfrChart.destroy();
                    cfrChart = new Chart(document.getElementById('cfrChart'), {
                        type: 'bar',
                        data: {
                            labels: data.dates,
                            datasets: [{
                                label: '病死率 (%)',
                                data: data.cfr_values,
                                backgroundColor: 'rgba(231, 76, 60, 0.5)'
                            }]
                        }
                    });
                });
    }

    function onTrendChange() {
        const selected = document.getElementById('trend_selector').value;
        loadGrowthTrend(selected);
        loadRtChart(selected);
        loadCfrChart(selected);
    }

    window.onload = () => {
        const defaultCountry = 'GLOBAL';
        loadGrowthTrend(defaultCountry);
        loadRtChart(defaultCountry);
        loadCfrChart(defaultCountry);
    };
</script>
{% include 'footer.html' %}
</body>
</html>