<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒæ–°å† ç–«æƒ…æ•°æ®åˆ†æç»Ÿè®¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="container-fluid px-0">
    <header class="header py-3">
        <div class="container">
            <h1 class="text-center mb-0">å…¨çƒæ–°å† ç–«æƒ…æ•°æ®åˆ†æç»Ÿè®¡ç³»ç»Ÿ</h1>
        </div>
    </header>

    <!-- å¯¼èˆªèœå• -->
    {% include 'navbar.html' %}

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="container-fluid px-4 mt-3">
        <!-- ä¸»è¦å±•ç¤ºåŒºåŸŸ -->
        <div class="row mb-4">
            <!-- å·¦ä¾§åœ°å›¾åŒºåŸŸ -->
            <div class="col-md-9 mb-3">
                <div class="global-stats-card">
                    <h5 class="section-title">ä¸­å›½ç´¯è®¡æ­»äº¡/ç¡®è¯Š/æ²»æ„ˆç—…ä¾‹æ•°:</h5>
                    <div id="world-map" class="world-map"></div>
                </div>
            </div>
            <!-- å³ä¾§æ’è¡Œæ¦œ -->
            <div class="col-md-3 mb-3">
                <div class="today-stats-card">
                    <h5 class="section-title">ä»Šæ—¥æ–°å¢</h5>
                    <div class="daily-stats">
                        <div id="top-countries-chart" class="top-countries-chart">
                            <h6>ç´¯è®¡ç¡®è¯Šäººæ•°Top5çš„çœä»½</h6>
                            <div id="top-chart-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- å³ä¸‹è§’å›ºå®šæŒ‰é’® -->
    <button type="button" class="btn-province-select position-fixed"
            style="bottom: 20px; right: 20px; z-index: 1050;"
            data-bs-toggle="modal" data-bs-target="#provinceModal">
        é€‰æ‹©çœä»½
    </button>

    <!-- çœä»½é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal fade" id="provinceModal" tabindex="-1" aria-labelledby="provinceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable"> <!-- å¯æ»šåŠ¨ -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="provinceModalLabel">é€‰æ‹©çœä»½</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="provinceList">
                        <!-- çœä»½åˆ—è¡¨é¡¹è¿™é‡ŒåŠ¨æ€ç”Ÿæˆæˆ–å†™æ­» -->
                        <button type="button" class="list-group-item list-group-item-action">åŒ—äº¬å¸‚</button>
                        <button type="button" class="list-group-item list-group-item-action">å¤©æ´¥å¸‚</button>
                        <button type="button" class="list-group-item list-group-item-action">æ²³åŒ—çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">å±±è¥¿çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">å†…è’™å¤è‡ªæ²»åŒº</button>
                        <button type="button" class="list-group-item list-group-item-action">è¾½å®çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">å‰æ—çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">é»‘é¾™æ±Ÿçœ</button>
                        <button type="button" class="list-group-item list-group-item-action">ä¸Šæµ·å¸‚</button>
                        <button type="button" class="list-group-item list-group-item-action">æ±Ÿè‹çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">æµ™æ±Ÿçœ</button>
                        <button type="button" class="list-group-item list-group-item-action">å®‰å¾½çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">ç¦å»ºçœ</button>
                        <button type="button" class="list-group-item list-group-item-action">æ±Ÿè¥¿çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">å±±ä¸œçœ</button>
                        <button type="button" class="list-group-item list-group-item-action">æ²³å—çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">æ¹–åŒ—çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">æ¹–å—çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">å¹¿ä¸œçœ</button>
                        <button type="button" class="list-group-item list-group-item-action">å¹¿è¥¿å£®æ—è‡ªæ²»åŒº</button>
                        <button type="button" class="list-group-item list-group-item-action">æµ·å—çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">é‡åº†å¸‚</button>
                        <button type="button" class="list-group-item list-group-item-action">å››å·çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">è´µå·çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">äº‘å—çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">è¥¿è—è‡ªæ²»åŒº</button>
                        <button type="button" class="list-group-item list-group-item-action">é™•è¥¿çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">ç”˜è‚ƒçœ</button>
                        <button type="button" class="list-group-item list-group-item-action">é’æµ·çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">å®å¤å›æ—è‡ªæ²»åŒº</button>
                        <button type="button" class="list-group-item list-group-item-action">æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº</button>
                        <button type="button" class="list-group-item list-group-item-action">å°æ¹¾çœ</button>
                        <button type="button" class="list-group-item list-group-item-action">é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº</button>
                        <button type="button" class="list-group-item list-group-item-action">æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº</button>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    async function loadTop5ProvinceChart() {
    console.log("ğŸš€ å¼€å§‹åŠ è½½Top5å›¾è¡¨");

    const res = await fetch("/api/china/province/top5");
    const data = await res.json();

    console.log("Top5è¿”å›æ•°æ®ï¼š", data);

    const container = document.getElementById("top-chart-container");
    if (!container) {
        console.warn("æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ top-chart-container");
        return;
    }

    if (!data || !data.length) {
        container.innerHTML = '<p class="text-muted">æš‚æ— æ•°æ®</p>';
        return;
    }

    container.innerHTML = '';
    const canvas = document.createElement("canvas");
    container.appendChild(canvas);

    new Chart(canvas, {
        type: 'bar',
        data: {
            labels: data.map(d => d.province),
            datasets: [{
                label: 'ç´¯è®¡ç¡®è¯Š',
                data: data.map(d => d.confirmed),
                backgroundColor: 'rgba(255,99,132,0.6)'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true
        }
    });
}


function setupProvinceClicks() {
    const provinceList = document.getElementById("provinceList");
    if (!provinceList) return;

    const buttons = provinceList.querySelectorAll("button");
    buttons.forEach(btn => {
        btn.addEventListener('click', () => {
            const province = encodeURIComponent(btn.innerText);
            window.location.href = `/china/province?name=${province}`;
        });
    });
}


// é¡µé¢è‡ªåŠ¨æ£€æµ‹æ˜¯å¦æ˜¯ china é¡µé¢ï¼Œå†æ‰§è¡Œé€»è¾‘
document.addEventListener("DOMContentLoaded", () => {
    if (window.location.pathname.includes("/china")) {
        try {
            initWorldMap();
        } catch (e) {
            console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥", e);
        }

        loadChinaMapAndStats();
        loadTop5ProvinceChart();
        setupProvinceClicks();
    }
});

</script>
{% include 'footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>