<!DOCTYPE html>
<html>
<head>
    <title>å…¨çƒæ–°å† ç–«æƒ…æ•°æ®åˆ†æç»Ÿè®¡ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>

        /* âœ… å°±åœ¨è¿™é‡Œé¢åŠ ä¸Šå¯¼èˆªæ æ ·å¼ */
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .nav-btn {
            padding: 10px 40px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .nav-btn:hover {
            background-color: #f0f0f0;
        }

        .nav-btn.active {
            background-color: #333;
            color: #fff;
            font-weight: bold;
        }

    </style>


    <title>å…¨çƒæ–°å† ç–«æƒ…æ•°æ®åˆ†æç»Ÿè®¡ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        /* ğŸ“ ä¸‰åˆ—ç½‘æ ¼å¸ƒå±€ + è‡ªå®šä¹‰åŒºåŸŸåç§° */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* å››åˆ— */
            grid-template-areas:
        "info      pie         person       search"
        "summary   vaccine     million      trend"
        "global    global      global       global";

            gap: 20px;
        }


        /* ğŸ“¦ æ¯ä¸ªæ¨¡å—å¡ç‰‡å¤–è§‚ */
        .card {
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 16px;
        }

        h4 {
            margin-top: 0;
        }

        canvas {
            max-width: 100%;
        }

        .grid-area-trend {
            height: 100%;
            align-self: stretch;
        }

    </style>
</head>

<body>
<!-- âœ… æ˜¾ç¤ºåœ¨é¡µé¢çš„ä¸»æ ‡é¢˜ -->
<h1 style="text-align: center; margin-bottom: 10px;">
    å…¨çƒæ–°å† ç–«æƒ…æ•°æ®åˆ†æç»Ÿè®¡ç³»ç»Ÿ
</h1>

<!-- ğŸ” é¡¶éƒ¨å¯¼èˆªæ  -->
{% include 'navbar.html' %}


<!-- ğŸŒ ä¸»ä»ªè¡¨ç›˜åŒºåŸŸ -->
<div class="dashboard">
    <!-- ğŸ§¾ å›½å®¶ä¿¡æ¯åŒºåŸŸ -->
    <div class="card" style="grid-area: info;">
        <h4>å›½å®¶ä¿¡æ¯</h4>
        <p>å›½å®¶ï¼š<span id="country_name">åŠ è½½ä¸­...</span></p>
        <p>ç»çº¬åº¦ï¼š<span id="latlng">åŠ è½½ä¸­...</span></p>
        <p>æ‰€å±æ´²ï¼š<span id="continent">åŠ è½½ä¸­...</span></p>
        <p><img id="flag" src="" alt="å›½æ——" width="100"/></p>
    </div>

    <!-- ğŸ© å½“å‰ç—…ä¾‹é¥¼å›¾ -->
    <div class="card" style="grid-area: pie;">
        <h4>å½“å‰ç—…ä¾‹å æ¯”</h4>
        <canvas id="currentCasePie"></canvas>
    </div>

    <!-- ğŸ“Š æ¯æ„ŸæŸ“/æ­»äº¡/æ£€æµ‹æ‰€éœ€äººå£å›¾ -->
    <div class="card" style="grid-area: person;">
        <h4>æ¯æ„ŸæŸ“ / æ¯æ­»äº¡ / æ¯æ£€æµ‹ æ‰€éœ€äººå£</h4>
        <canvas id="personPerEventChart"></canvas>
        <p>æ¯æ„ŸæŸ“1äººæ‰€éœ€äººå£ï¼š<span id="people_per_case">--</span></p>
        <p>æ¯æ­»äº¡1äººæ‰€éœ€äººå£ï¼š<span id="people_per_death">--</span></p>
        <p>æ¯æ£€æµ‹1äººæ‰€éœ€äººå£ï¼š<span id="people_per_test">--</span></p>
    </div>

    <!-- ğŸ“„ æ•°æ®æ€»è§ˆ -->
    <div class="card" style="grid-area: summary;">
        <h4>æ•°æ®æ€»è§ˆ</h4>
        <p>ç´¯è®¡ç¡®è¯Šï¼š<span id="cases">--</span></p>
        <p>ç°æœ‰ç¡®è¯Šï¼š<span id="active">--</span></p>
        <p>ç´¯è®¡åº·å¤ï¼š<span id="recovered">--</span></p>
        <p>ç´¯è®¡æ­»äº¡ï¼š<span id="deaths">--</span></p>
        <p>é‡ç—‡ç—…ä¾‹ï¼š<span id="critical">--</span></p>
        <p>æ£€æµ‹æ€»æ¬¡æ•°ï¼š<span id="tests">--</span></p>
        <p>æ•°æ®æ›´æ–°æ—¶é—´ï¼š<span id="updated_at">--</span></p>
    </div>

    <!-- ğŸ’‰ ç–«è‹—è¶‹åŠ¿å›¾ -->
    <div class="card" style="grid-area: vaccine;">
        <h4>ç–«è‹—æ¥ç§ç´¯è®¡è¶‹åŠ¿å›¾</h4>
        <canvas id="vaccineTrendChart" height="150"></canvas>
    </div>

    <!-- ğŸ“Š æ¯ç™¾ä¸‡äººç–«æƒ…æŒ‡æ ‡å›¾ -->
    <div class="card" style="grid-area: million;">
        <h4>æ¯ç™¾ä¸‡äººç–«æƒ…æŒ‡æ ‡</h4>
        <canvas id="perMillionChart"></canvas>
        <p>æ¯ç™¾ä¸‡äººç¡®è¯Šæ•°ï¼š<span id="cases_per_million">--</span></p>
        <p>æ¯ç™¾ä¸‡äººæ­»äº¡æ•°ï¼š<span id="deaths_per_million">--</span></p>
        <p>æ¯ç™¾ä¸‡äººæ´»è·ƒæ•°ï¼š<span id="active_per_million">--</span></p>
        <p>æ¯ç™¾ä¸‡äººåº·å¤æ•°ï¼š<span id="recovered_per_million">--</span></p>
        <p>æ¯ç™¾ä¸‡äººé‡ç—‡æ•°ï¼š<span id="critical_per_million">--</span></p>
    </div>
    <!-- ğŸ” å›½å®¶æœç´¢åŒºåŸŸ -->
    <div class="card" style="grid-area: search; height: 100px;">
        <label style="font-weight: bold;">è¯·è¾“å…¥å›½å®¶ä»£ç ï¼š</label>
        <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
            <input
                    type="text"
                    id="country_input"
                    placeholder="å¦‚ CN æˆ– US"
                    style="flex: 1; max-width: 150px; padding: 6px; font-size: 14px;"
            />
            <button onclick="onSearch()" style="padding: 6px 12px; font-size: 14px;">æŸ¥è¯¢</button>
        </div>
    </div>


    <!-- è¶‹åŠ¿å›¾æ¨¡å—ï¼šæ·»åŠ æ—¥æœŸé€‰æ‹© -->
    <div class="card" style="grid-area: trend;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <label>èµ·å§‹æ—¥æœŸï¼š</label>
                <input type="date" id="start_date" style="padding: 4px;"/>
                <label>ç»“æŸæ—¥æœŸï¼š</label>
                <input type="date" id="end_date" style="padding: 4px;"/>
                <button onclick="loadTrendChart(currentCountryCode)" style="padding: 4px 10px; margin-left: 6px;">æŸ¥è¯¢
                </button>
            </div>
            <div style="font-weight: bold; font-size: 18px;">è¶‹åŠ¿</div>
        </div>

        <p id="trend_date_range" style="margin-top: 10px;">åŠ è½½ä¸­...</p>
        <canvas id="trendChart" height="150"></canvas>
    </div>
    {% include 'footer.html' %}

</div>

<script>
    let pieChart = null;
    let personChart = null;
    let millionChart = null;
    let vaccineChart = null;
    let trendChart = null;
    let currentCountryCode = 'CN';


    //  åŠ è½½å›½å®¶åŸºç¡€ä¿¡æ¯
    function loadCountryInfo(code = 'CN') {
        fetch(`/api/country/info?code=${code}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("country_name").innerText = data.country;
                    document.getElementById("latlng").innerText = data.latitude + ', ' + data.longitude;
                    document.getElementById("continent").innerText = data.continent;
                    document.getElementById("flag").src = data.flag_url;
                });
    }

    // ğŸ“Š åŠ è½½å›½å®¶å®æ—¶æ•°æ® + é¥¼å›¾ + ç™¾ä¸‡äººå›¾ + æ¯æ„ŸæŸ“äººå£å›¾
    function loadCountryStats(code = 'CN') {
        fetch(`/api/country/stats?code=${code}`)
                .then(res => res.json())
                .then(data => {
                    // å¡«å……æ•°æ®
                    document.getElementById("cases").innerText = data.cases.toLocaleString();
                    document.getElementById("active").innerText = data.active.toLocaleString();
                    document.getElementById("recovered").innerText = data.recovered.toLocaleString();
                    document.getElementById("deaths").innerText = data.deaths.toLocaleString();
                    document.getElementById("critical").innerText = data.critical.toLocaleString();
                    document.getElementById("tests").innerText = data.tests.toLocaleString();

                    // å½“å‰ç—…ä¾‹é¥¼å›¾
                    if (pieChart) pieChart.destroy();
                    pieChart = new Chart(document.getElementById('currentCasePie'), {
                        type: 'pie',
                        data: {
                            labels: ['æ´»è·ƒç—…ä¾‹', 'åº·å¤', 'æ­»äº¡'],
                            datasets: [{
                                data: [data.active, data.recovered, data.deaths],
                                backgroundColor: ['#f39c12', '#27ae60', '#c0392b']
                            }]
                        }
                    });

                    // æ¯æ„ŸæŸ“/æ­»äº¡/æ£€æµ‹æ‰€éœ€äººå£
                    const pop = data.population;
                    const peoplePerCase = (pop / data.cases).toFixed(2);
                    const peoplePerDeath = (pop / data.deaths).toFixed(2);
                    const peoplePerTest = (pop / data.tests).toFixed(2);

                    document.getElementById("people_per_case").innerText = peoplePerCase;
                    document.getElementById("people_per_death").innerText = peoplePerDeath;
                    document.getElementById("people_per_test").innerText = peoplePerTest;

                    if (personChart) personChart.destroy();
                    personChart = new Chart(document.getElementById('personPerEventChart'), {
                        type: 'bar',
                        data: {
                            labels: ['æ¯æ„ŸæŸ“1äºº', 'æ¯æ­»äº¡1äºº', 'æ¯æ£€æµ‹1äºº'],
                            datasets: [{
                                label: 'æ‰€éœ€äººå£æ•°',
                                data: [peoplePerCase, peoplePerDeath, peoplePerTest],
                                backgroundColor: 'rgba(153, 102, 255, 0.5)'
                            }]
                        }
                    });

                    // æ¯ç™¾ä¸‡äººæŒ‡æ ‡
                    const perMillion = n => ((n / pop) * 1000000).toFixed(2);
                    document.getElementById("cases_per_million").innerText = perMillion(data.cases);
                    document.getElementById("deaths_per_million").innerText = perMillion(data.deaths);
                    document.getElementById("active_per_million").innerText = perMillion(data.active);
                    document.getElementById("recovered_per_million").innerText = perMillion(data.recovered);
                    document.getElementById("critical_per_million").innerText = perMillion(data.critical);

                    if (millionChart) millionChart.destroy();
                    millionChart = new Chart(document.getElementById('perMillionChart'), {
                        type: 'bar',
                        data: {
                            labels: ['ç¡®è¯Š', 'æ­»äº¡', 'æ´»è·ƒ', 'åº·å¤', 'é‡ç—‡'],
                            datasets: [{
                                label: 'æ¯ç™¾ä¸‡äººæ•°é‡',
                                data: [
                                    perMillion(data.cases),
                                    perMillion(data.deaths),
                                    perMillion(data.active),
                                    perMillion(data.recovered),
                                    perMillion(data.critical)
                                ],
                                backgroundColor: 'rgba(255, 159, 64, 0.5)'
                            }]
                        }
                    });
                });
    }

    // ğŸ’‰ ç–«è‹—æŠ˜çº¿å›¾
    function loadVaccineTrend(code = 'CN') {
        fetch(`/api/vaccine/trend?code=${code}`)
                .then(res => res.json())
                .then(data => {
                    if (vaccineChart) vaccineChart.destroy();
                    vaccineChart = new Chart(document.getElementById('vaccineTrendChart'), {
                        type: 'line',
                        data: {
                            labels: data.dates,
                            datasets: [{
                                label: 'ç´¯è®¡æ¥ç§å‰‚æ•°',
                                data: data.doses,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        }
                    });
                });
    }

    // ğŸ“ˆ å›½å®¶ç¡®è¯Š/æ­»äº¡/åº·å¤è¶‹åŠ¿å›¾


    function loadTrendChart(code = 'CN') {
        currentCountryCode = code;

        const start = document.getElementById("start_date")?.value;
        const end = document.getElementById("end_date")?.value;

        let url = `/api/country/trend?code=${code}`;
        if (start && end) {
            url += `&start=${start}&end=${end}`;
        }

        fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.dates || data.dates.length === 0) {
                        document.getElementById('trend_date_range').innerText = 'æš‚æ— æ•°æ®';
                        if (trendChart) trendChart.destroy();
                        return;
                    }

                    const from = data.dates[0];
                    const to = data.dates[data.dates.length - 1];
                    document.getElementById('trend_date_range').innerText = `${from} - ${to}`;

                    if (trendChart) trendChart.destroy();
                    trendChart = new Chart(document.getElementById('trendChart'), {
                        type: 'line',
                        data: {
                            labels: data.dates,
                            datasets: [
                                {
                                    label: 'ç´¯è®¡ç¡®è¯Š',
                                    data: data.cases,
                                    borderColor: '#3498db',
                                    tension: 0.3
                                },
                                {
                                    label: 'ç´¯è®¡æ­»äº¡',
                                    data: data.deaths,
                                    borderColor: '#e74c3c',
                                    tension: 0.3
                                },
                                {
                                    label: 'ç´¯è®¡åº·å¤',
                                    data: data.recovered,
                                    borderColor: '#2ecc71',
                                    tension: 0.3
                                }
                            ]
                        }
                    });
                });
    }

    // æœç´¢
    function onSearch() {
        const code = document.getElementById("country_input").value.trim().toUpperCase();

        if (!code) {
            alert("è¯·è¾“å…¥å›½å®¶ä»£ç ï¼");
            return;
        }

        // åˆ‡æ¢å…¨éƒ¨æ•°æ®
        loadCountryInfo(code);
        loadCountryStats(code);
        loadVaccineTrend(code);
        loadTrendChart(code);
    }

    // ğŸŸ¢ é¡µé¢åŠ è½½åè‡ªåŠ¨è°ƒç”¨æ‰€æœ‰åŠ è½½å‡½æ•°
    window.onload = () => {
        loadCountryInfo('CN');
        loadCountryStats('CN');
        loadVaccineTrend('CN');
        loadTrendChart('CN');
    };

    fetch("/navbar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("nav-placeholder").innerHTML = html;
            });

</script>


</body>
</html>
