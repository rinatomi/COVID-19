<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球新冠疫情数据分析统计系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>

        /* 📐 三列网格布局 + 自定义区域名称 */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 四列 */
            grid-template-areas:
        "info      pie         person       search"
        "summary   vaccine     million      trend"
        "global    global      global       global";

            gap: 20px;
        }


        /* 📦 每个模块卡片外观 */
        .card {
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 16px;
        }

        h4 {
            margin-top: 0;
        }

        canvas {
            max-width: 100%;
        }

    </style>
</head>

<body>
<div class="container-fluid px-0">
    <!-- ✅ 显示在页面的主标题 -->
    <header class="header py-3">
        <div class="container">
            <h1 class="text-center mb-0">全球新冠疫情数据分析统计系统</h1>
        </div>
    </header>

    <!-- 🔍 顶部导航栏 -->
    {% include 'navbar.html' %}

    <!-- 🌐 主仪表盘区域 -->
    <div class="container-fluid px-4 mt-3 dashboard">

        <!-- 🧾 国家信息区域 -->
        <div class="card" style="grid-area: info;">
            <h4>国家信息</h4>
            <p>国家：<span id="country_name">加载中...</span></p>
            <p>经纬度：<span id="latlng">加载中...</span></p>
            <p>所属洲：<span id="continent">加载中...</span></p>
            <p><img id="flag" src="" alt="国旗" width="100"/></p>
        </div>

        <!-- 🍩 当前病例饼图 -->
        <div class="card" style="grid-area: pie;">
            <h4>当前病例占比</h4>
            <canvas id="currentCasePie"></canvas>
        </div>

        <!-- 📊 每感染/死亡/检测所需人口图 -->
        <div class="card" style="grid-area: person;">
            <h4>每感染 / 每死亡 / 每检测 所需人口</h4>
            <canvas id="personPerEventChart"></canvas>
            <p>每感染1人所需人口：<span id="people_per_case">--</span></p>
            <p>每死亡1人所需人口：<span id="people_per_death">--</span></p>
            <p>每检测1人所需人口：<span id="people_per_test">--</span></p>
        </div>

        <!-- 📄 数据总览 -->
        <div class="card" style="grid-area: summary;">
            <h4>数据总览</h4>
            <p>累计确诊：<span id="cases">--</span></p>
            <p>现有确诊：<span id="active">--</span></p>
            <p>累计康复：<span id="recovered">--</span></p>
            <p>累计死亡：<span id="deaths">--</span></p>
            <p>重症病例：<span id="critical">--</span></p>
            <p>检测总次数：<span id="tests">--</span></p>
            <p>数据更新时间：<span id="updated_at">--</span></p>
        </div>

        <!-- 💉 疫苗趋势图 -->
        <div class="card" style="grid-area: vaccine;">
            <h4>疫苗接种累计趋势图</h4>
            <canvas id="vaccineTrendChart" height="150"></canvas>
        </div>

        <!-- 📊 每百万人疫情指标图 -->
        <div class="card" style="grid-area: million;">
            <h4>每百万人疫情指标</h4>
            <canvas id="perMillionChart"></canvas>
            <p>每百万人确诊数：<span id="cases_per_million">--</span></p>
            <p>每百万人死亡数：<span id="deaths_per_million">--</span></p>
            <p>每百万人活跃数：<span id="active_per_million">--</span></p>
            <p>每百万人康复数：<span id="recovered_per_million">--</span></p>
            <p>每百万人重症数：<span id="critical_per_million">--</span></p>
        </div>
        <!-- 🔍 国家搜索区域 -->
        <div class="card" style="grid-area: search; height: 100px;">
            <label style="font-weight: bold;">请输入国家代码：</label>
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                <input
                        type="text"
                        id="country_input"
                        placeholder="如 CN 或 US"
                        style="flex: 1; max-width: 150px; padding: 6px; font-size: 14px;"
                />
                <button onclick="onSearch()" style="padding: 6px 12px; font-size: 14px;">查询</button>
            </div>
        </div>


        <!-- 趋势图模块：添加日期选择 -->
        <div class="card" style="grid-area: trend;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <label>起始日期：</label>
                    <input type="date" id="start_date" style="padding: 4px;"/>
                    <label>结束日期：</label>
                    <input type="date" id="end_date" style="padding: 4px;"/>
                    <button onclick="loadTrendChart(currentCountryCode)" style="padding: 4px 10px; margin-left: 6px;">查询
                    </button>
                </div>
                <div style="font-weight: bold; font-size: 18px;">趋势</div>
            </div>

            <p id="trend_date_range" style="margin-top: 10px;">加载中...</p>
            <canvas id="trendChart" height="150"></canvas>
        </div>

    </div>
</div>
<script>
    let pieChart = null;
    let personChart = null;
    let millionChart = null;
    let vaccineChart = null;
    let trendChart = null;
    let currentCountryCode = 'CN';


    //  加载国家基础信息
    function loadCountryInfo(code = 'CN') {
        fetch(`/api/country/info?code=${code}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("country_name").innerText = data.country;
                    document.getElementById("latlng").innerText = data.latitude + ', ' + data.longitude;
                    document.getElementById("continent").innerText = data.continent;
                    document.getElementById("flag").src = data.flag_url;
                });
    }

    // 📊 加载国家实时数据 + 饼图 + 百万人图 + 每感染人口图
    function loadCountryStats(code = 'CN') {
        fetch(`/api/country/stats?code=${code}`)
                .then(res => res.json())
                .then(data => {
                    // 填充数据
                    document.getElementById("cases").innerText = data.cases.toLocaleString();
                    document.getElementById("active").innerText = data.active.toLocaleString();
                    document.getElementById("recovered").innerText = data.recovered.toLocaleString();
                    document.getElementById("deaths").innerText = data.deaths.toLocaleString();
                    document.getElementById("critical").innerText = data.critical.toLocaleString();
                    document.getElementById("tests").innerText = data.tests.toLocaleString();

                    // 当前病例饼图
                    if (pieChart) pieChart.destroy();
                    pieChart = new Chart(document.getElementById('currentCasePie'), {
                        type: 'pie',
                        data: {
                            labels: ['活跃病例', '康复', '死亡'],
                            datasets: [{
                                data: [data.active, data.recovered, data.deaths],
                                backgroundColor: ['#f39c12', '#27ae60', '#c0392b']
                            }]
                        }
                    });

                    // 每感染/死亡/检测所需人口
                    const pop = data.population;
                    const peoplePerCase = (pop / data.cases).toFixed(2);
                    const peoplePerDeath = (pop / data.deaths).toFixed(2);
                    const peoplePerTest = (pop / data.tests).toFixed(2);

                    document.getElementById("people_per_case").innerText = peoplePerCase;
                    document.getElementById("people_per_death").innerText = peoplePerDeath;
                    document.getElementById("people_per_test").innerText = peoplePerTest;

                    if (personChart) personChart.destroy();
                    personChart = new Chart(document.getElementById('personPerEventChart'), {
                        type: 'bar',
                        data: {
                            labels: ['每感染1人', '每死亡1人', '每检测1人'],
                            datasets: [{
                                label: '所需人口数',
                                data: [peoplePerCase, peoplePerDeath, peoplePerTest],
                                backgroundColor: 'rgba(153, 102, 255, 0.5)'
                            }]
                        }
                    });

                    // 每百万人指标
                    const perMillion = n => ((n / pop) * 1000000).toFixed(2);
                    document.getElementById("cases_per_million").innerText = perMillion(data.cases);
                    document.getElementById("deaths_per_million").innerText = perMillion(data.deaths);
                    document.getElementById("active_per_million").innerText = perMillion(data.active);
                    document.getElementById("recovered_per_million").innerText = perMillion(data.recovered);
                    document.getElementById("critical_per_million").innerText = perMillion(data.critical);

                    if (millionChart) millionChart.destroy();
                    millionChart = new Chart(document.getElementById('perMillionChart'), {
                        type: 'bar',
                        data: {
                            labels: ['确诊', '死亡', '活跃', '康复', '重症'],
                            datasets: [{
                                label: '每百万人数量',
                                data: [
                                    perMillion(data.cases),
                                    perMillion(data.deaths),
                                    perMillion(data.active),
                                    perMillion(data.recovered),
                                    perMillion(data.critical)
                                ],
                                backgroundColor: 'rgba(255, 159, 64, 0.5)'
                            }]
                        }
                    });
                });
    }

    // 💉 疫苗折线图
    function loadVaccineTrend(code = 'CN') {
        fetch(`/api/vaccine/trend?code=${code}`)
                .then(res => res.json())
                .then(data => {
                    if (vaccineChart) vaccineChart.destroy();
                    vaccineChart = new Chart(document.getElementById('vaccineTrendChart'), {
                        type: 'line',
                        data: {
                            labels: data.dates,
                            datasets: [{
                                label: '累计接种剂数',
                                data: data.doses,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        }
                    });
                });
    }

    // 📈 国家确诊/死亡/康复趋势图


    function loadTrendChart(code = 'CN') {
        currentCountryCode = code;

        const start = document.getElementById("start_date")?.value;
        const end = document.getElementById("end_date")?.value;

        let url = `/api/country/trend?code=${code}`;
        if (start && end) {
            url += `&start=${start}&end=${end}`;
        }

        fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.dates || data.dates.length === 0) {
                        document.getElementById('trend_date_range').innerText = '暂无数据';
                        if (trendChart) trendChart.destroy();
                        return;
                    }

                    const from = data.dates[0];
                    const to = data.dates[data.dates.length - 1];
                    document.getElementById('trend_date_range').innerText = `${from} - ${to}`;

                    if (trendChart) trendChart.destroy();
                    trendChart = new Chart(document.getElementById('trendChart'), {
                        type: 'line',
                        data: {
                            labels: data.dates,
                            datasets: [
                                {
                                    label: '累计确诊',
                                    data: data.cases,
                                    borderColor: '#3498db',
                                    tension: 0.3
                                },
                                {
                                    label: '累计死亡',
                                    data: data.deaths,
                                    borderColor: '#e74c3c',
                                    tension: 0.3
                                },
                                {
                                    label: '累计康复',
                                    data: data.recovered,
                                    borderColor: '#2ecc71',
                                    tension: 0.3
                                }
                            ]
                        }
                    });
                });
    }

    // 搜索
    function onSearch() {
        const code = document.getElementById("country_input").value.trim().toUpperCase();

        if (!code) {
            alert("请输入国家代码！");
            return;
        }

        // 切换全部数据
        loadCountryInfo(code);
        loadCountryStats(code);
        loadVaccineTrend(code);
        loadTrendChart(code);
    }

    // 🟢 页面加载后自动调用所有加载函数
    window.onload = () => {
        loadCountryInfo('CN');
        loadCountryStats('CN');
        loadVaccineTrend('CN');
        loadTrendChart('CN');
    };

    fetch("/navbar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("nav-placeholder").innerHTML = html;
            });

</script>

{% include 'footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>


</body>
</html>
